# Odometry with Tree Extraction
<!-- TODO:
        correct the flow of the sentences -->
Odometry can be used to measure the movement of the robot calculated by the change in position of different and/or multiple sensors. One way to perform odometry is with the use of a camera and a Lidar. The frames generated by the camera can be used to extract certain points out of the frames as reference points in order to localize the robot relative to these points. Similarly, the Lidar is mainly used to create a map of the environment. But from the environment, certain points can be extracted with the same purpose as the camera. Using the same extraction methods on different input sources, forces us to use the same, or similar enough, datatypes. Hence why pointclouds are used to perform extraction. From the Lidar a pointcloud is the raw output. For the camera, a simple conversion is needed to convert the frames, in depth, infrared or color, to a pointcloud.

To summarise, odometry will be implemented with both the camera and lidar by finding features in pointclouds.

There are multiple features that can be focussed on, for example, certain poles positioned at checkpoints, an empty section indicating the end of the row. But one solution, that is complex but the objects are always present, is extracting trees. More importantly, the tree stems. A Tree Extraction algorithm, called [TreeSeg](https://github.com/apburt/treeseg), is a tree identification and segmentation algorithm that extracts tree stumps, stems and the crown by finding cylinder like forms in the pointclouds.

## What is tree extraction?

## Pre-requirements to run TreeSeg

<!-- PCL installation
library, path, includes, linking -->

<!-- TODO:
        Explain what kind of data are in these directories -->
## Structure

In this directory multiple sub-directories are created to divide the camera, lidar and png files.

The ply files are extracted from the Neuvision viewer and then converted to pcd files with a python script. The pcd file stands for Point Cloud Data, pcd is what the Point Cloud Library requires as input, logically, TreeSeg does too.

The file names are ordered with a number, so that we know which the ply, pcd, png and dat belong to each other.

## Steps

Given that we converted the ply file to pcd, we can begin with getting the dtm.dat file. Which stands for Digital Terrain Model data file. Containing the x y z of the terrain extracted from the input pcd.

> getdtmslice 2 2.5 3 6 somepcdfilename.tile.0.pcd > somedatfilename.dtm.dat

The arguments are explained in the documentation of TreeSeg (link to TreeSeg)

<!-- TODO: 
        explain breefly how TreeSeg works, the steps and links to the documentation -->
## Tree identification

- Euclidean clustering
  - Divide in clusters based on spatial distances
- Region-based segmentation
  - Reduce clusters to regions based on underlying surface properties
- Shape fitting-RANSAC
  - Try to fit cylinders to each region
  - determine the likelihood of a stem
- PCA
  - Calculate the angle between region and ground
  - regions perpendicular to ground more likely to be stems

## Stem segmentation

- Shape fitting-RANSAC
  - describe orientation and radius of each stem
- Spatial Filtering
  - generate sections of the larger point cloud containing each stem and vegetation
- Plane fitting
  - Classification
- Region-based segmentation
  - Organise sections to region, to classify each element of vegetation